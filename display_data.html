<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CPShareTXT - Saved Texts</title>
  <link rel="icon" href="icontxt.webp" />

  <!-- Bootstrap + icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

  <!-- AOS -->
  <link href="https://unpkg.com/aos@2.3.4/dist/aos.css" rel="stylesheet">

  <!-- Lottie -->
  <script src="https://unpkg.com/@lottiefiles/lottie-player@1.5.7/dist/lottie-player.js"></script>

  <!-- SweetAlert2 -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

     <style>
  :root{
    --accent: #06b6d4;
    --accent-2: #0891b2;
    --muted: #9ca3af;
    --bg-dark: linear-gradient(180deg,#041022 0%, #06122a 100%);
    --panel-bg: rgba(255,255,255,0.03);
    --card-radius: 18px;
    --focus: rgba(6,182,212,0.25);
    --max-width: 1120px;
    --ui-ease: cubic-bezier(.2,.9,.2,1);
  }

  /* --- Base --- */
  body, html {
    margin:0; padding:0; height:100%;
    font-family: 'Inter', system-ui, -apple-system, "Segoe UI", Roboto, Arial;
    color:#e8f7fb;
    background:radial-gradient(1000px 600px at 10% 10%, rgba(6,182,212,0.04), transparent), var(--bg-dark);
    display:flex; flex-direction:column; transition: background .3s, color .3s;
  }

  body.light { color:#06202a; background: linear-gradient(180deg,#f7fbff 0%, #eef6ff 100%); }

  .app-container { max-width: var(--max-width); width:94%; margin:20px auto; flex:1; }

  /* --- Header --- */
  header.d-flex { margin-bottom:18px; align-items:center; justify-content:space-between; gap:12px; }
  .brand-title { font-size:1.2rem; font-weight:800; }
  .brand-sub { font-size:.82rem; color:var(--muted); margin-top:2px; }

  nav a.muted { color: rgba(255,255,255,0.85); transition: color .2s; }
  nav a.muted:hover { color: #fff; text-decoration:none; }

  .btn-outline-custom {
    border:1px solid rgba(255,255,255,0.06); color:inherit; border-radius:0.7rem;
    background:transparent; padding:.45rem .85rem; transition:.25s;
  }
  .btn-outline-custom:hover { background: rgba(255,255,255,0.06); transform:translateY(-2px); }

  /* --- Cards --- */
  .card-glass {
    border-radius: var(--card-radius);
    padding:20px;
    background: linear-gradient(180deg, var(--panel-bg), rgba(255,255,255,0.01));
    border:1px solid rgba(255,255,255,0.05);
    box-shadow: 0 20px 60px rgba(2,10,18,0.5);
    transition: box-shadow .25s var(--ui-ease), background .25s var(--ui-ease);
  }
  body.light .card-glass { background: linear-gradient(180deg,#fff,#f7faff); border:1px solid rgba(2,6,23,0.05); box-shadow:0 10px 28px rgba(11,18,32,0.06); }

  h2 { margin-bottom:14px; font-size:1.35rem; font-weight:700; }

  .instructions {
    background: rgba(255,255,255,0.03); border-left: 5px solid var(--accent);
    padding:14px; margin:14px 0; border-radius:14px; color:#dff6fb;
    font-size:.92rem; line-height:1.5;
  }
  body.light .instructions { background:#f0fbff; color:#08303a; }

  /* --- Controls --- */
  .controls { display:flex; flex-wrap:wrap; gap:10px; align-items:center; margin-bottom:16px; }
  .search-input {
    flex:1; min-width:160px; max-width:720px;
    padding:.65rem 1rem; border-radius:.7rem; border:1px solid rgba(255,255,255,0.05);
    background: rgba(255,255,255,0.02); color:inherit; transition:.2s;
  }
  body.light .search-input { border-color: rgba(2,6,23,0.06); background:#fff; color:#06202a; }

  .btn-primary-solid {
    background: linear-gradient(135deg,var(--accent),var(--accent-2));
    color:#042028; font-weight:700; border:none; padding:.65rem 1.2rem; border-radius:.7rem;
    box-shadow:0 12px 36px rgba(6,182,212,0.08);
    transition:.22s;
  }
  .btn-primary-solid:hover { transform:translateY(-2px); }

  /* --- Records --- */
  .records-list { display:flex; flex-direction:column; gap:14px; margin-top:14px; }
  .record {
    display:flex; gap:14px; align-items:flex-start; padding:16px;
    border-radius:14px; background: linear-gradient(180deg, rgba(255,255,255,0.015), rgba(255,255,255,0.01));
    border:1px solid rgba(255,255,255,0.03); cursor:pointer;
    transition:.25s ease;
  }
  .record:hover, .record:focus { transform:translateY(-4px); box-shadow:0 28px 60px rgba(2,10,18,0.5); outline:none; }

  .avatar { width:56px; height:56px; border-radius:14px; display:grid; place-items:center; background:linear-gradient(135deg,var(--accent),var(--accent-2)); font-weight:800; color:#042028; flex-shrink:0; font-size:.95rem; }

  .rec-body { flex:1; display:flex; flex-direction:column; min-width:0; }
  .rec-head { display:flex; justify-content:space-between; align-items:flex-start; }
  .rec-name { font-weight:700; font-size:1rem; color:#eaffff; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  .rec-time { font-size:.82rem; color:var(--muted); }
  .rec-text { margin-top:10px; line-height:1.45; max-height:10rem; overflow:auto; white-space:pre-wrap; word-break:break-word; padding-right:6px; color:#cfeff7; }

  body.light .rec-name { color:#06202a; }
  body.light .rec-time { color:#3f5963; }
  body.light .rec-text { color:#18313a; }

  .rec-actions { display:flex; gap:8px; align-items:center; margin-left:8px; flex-shrink:0; flex-wrap:wrap; }

  .small-btn {
    border-radius:12px; padding:.45rem .65rem; font-size:.9rem;
    border:1px solid rgba(255,255,255,0.05); background:transparent; color:inherit;
    display:flex; align-items:center; gap:.35rem; transition:.2s;
  }
  .small-btn:hover { transform:scale(1.05); }

  .copy-btn { background: linear-gradient(135deg,#06b6d4,#0891b2); color:#042028; border:none; }
  .view-btn { background: linear-gradient(135deg,#facc15,#f59e0b); color:#042028; border:none; }
  .protect-btn { background: linear-gradient(135deg,#10b981,#059669); color:#fff; border:none; }
  .btn-danger { background: linear-gradient(135deg,#dc2626,#b91c1c); color:#fff; border:none; }

  .protect-badge { background:#16a34a; color:#fff; padding:.25rem .5rem; border-radius:8px; font-weight:700; font-size:.82rem; }

  .loading-inline { display:flex; gap:10px; align-items:center; color:var(--muted); margin-top:10px; }
  .empty { text-align:center; color:var(--muted); padding:20px 6px; font-size:.95rem; }

  /* --- Scroll-to-top --- */
  #scrollSide {
    position:fixed; right:18px; bottom:18px; z-index:1200;
    display:flex; align-items:center; gap:10px;
    background:linear-gradient(180deg,#072433,#0b3f51); color:#dff8fb;
    padding:8px 14px; border-radius:999px;
    box-shadow:0 12px 36px rgba(3,15,23,0.5);
    transition:.25s; opacity:0; pointer-events:none; cursor:pointer;
  }
  #scrollSide.show { opacity:1; pointer-events:auto; }
  #scrollSide .label { font-size:.88rem; font-weight:800; }
  #scrollSide button { background:transparent; border:none; color:inherit; font-size:1.1rem; padding:6px; border-radius:8px; display:grid; place-items:center; }

  /* --- Mobile adjustments --- */
  @media (max-width:720px){
    .record { flex-direction:column; padding:14px; }
    .rec-text { max-height:6.4rem; }
    .rec-actions {
      flex-wrap: nowrap; overflow-x:auto; padding-top:6px; margin-left:0; gap:8px;
      -webkit-overflow-scrolling: touch; scroll-behavior:smooth;
    }
    .rec-actions::-webkit-scrollbar { height:4px; }
    .rec-actions::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.15); border-radius:2px; }
    .small-btn { flex-shrink:0; min-width:72px; justify-content:center; font-size:.9rem; padding:.55rem .8rem; border-radius:.65rem; }
    .small-btn:active { transform: scale(0.94); }
  }

  /* --- Footer --- */
  footer { margin-top:20px; text-align:center; }
  footer .card-glass { display:inline-block; padding:16px 20px; border-radius:14px; }
  footer .muted { color: rgba(255,255,255,0.85); font-size:.82rem; }
  body.light footer .muted { color:#5b6b78; }

  :focus { outline: 3px solid var(--focus); outline-offset:3px; border-radius:6px; }
  </style>


</head>
<body>
  <div class="app-container">

    <!-- NAV -->
    <header class="d-flex align-items-center justify-content-between">
      <a href="/" class="d-flex align-items-center gap-3 text-decoration-none">
        <div style="width:56px;height:56px;border-radius:12px;background:linear-gradient(135deg,#06b6d4,#0891b2);display:flex;align-items:center;justify-content:center;">
          <lottie-player src="https://assets10.lottiefiles.com/packages/lf20_jtbfg2nb.json" background="transparent" speed="1" style="width:40px;height:40px" loop autoplay></lottie-player>
        </div>
        <div>
          <div class="brand-title">CP Share TXT</div>
          <div class="brand-sub muted">Fast • Private • Free</div>
        </div>
      </a>

      <nav class="d-flex align-items-center gap-2">
        <div class="d-none d-sm-inline nav-cta muted">Free •</div>
        <a href="display_data.html" class="text-decoration-none small px-2 py-1 rounded-2 muted">Saved</a>
        <a href="feedback_form.html" class="text-decoration-none small px-2 py-1 rounded-2 muted">Feedback</a>
        <a href="admin_panel.php" class="text-decoration-none small px-2 py-1 rounded-2 muted" style="background: rgba(255,255,255,0.03);">Admin</a>

        <button id="themeToggle" class="btn btn-sm btn-outline-custom ms-2" aria-label="Toggle theme" title="Toggle light/dark">
          <i id="themeIcon" class="bi bi-moon-fill"></i>
        </button>
      </nav>
    </header>

    <!-- Main -->
    <main class="card-glass" role="main" aria-labelledby="mainHeading" data-aos="fade-up">
      <h2 id="mainHeading">Saved Texts</h2>

      <div class="instructions" role="region" aria-label="User instructions">
        <strong>Quick instructions</strong>
        <ul style="margin:.5rem 0 0 1rem;color:#dff6fb">
          <li>Click <strong>Display Texts</strong> to load all saved records (newest first).</li>
          <li>Use buttons to <strong>View</strong> (open modal), <strong>Copy</strong>, <strong>Protect</strong>, or <strong>Delete</strong>.</li>
          <li>Protected texts are kept up to 1 month; unprotected entries may auto-delete after ~5 minutes.</li>
        </ul>
      </div>

      <div class="controls" aria-hidden="false">
        <input id="searchInput" class="search-input" type="search" placeholder="Search username or text (works while loading)" aria-label="Search records" />
        <!-- Display Files button: navigates to backend.php -->
        <button id="displayFilesBtn" class="btn btn-outline-custom" title="Display files (opens files page)"><i class="bi bi-folder2-open me-1"></i> Display Files</button>
        <button id="displayTextsBtn" class="btn btn-primary-solid" title="Show saved texts"><i class="bi bi-card-text me-1"></i> Display Texts</button>
        <button id="refreshBtn" class="btn btn-outline-custom" title="Refresh records"><i class="bi bi-arrow-clockwise"></i></button>
      </div>

      <div id="loadingRow" class="loading-inline" style="display:none">
        <div class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></div>
        <div id="loadingText" style="color:var(--muted)">Loading records…</div>
      </div>

      <div id="recordsList" class="records-list" aria-live="polite" aria-busy="false" tabindex="0"></div>
      <div id="emptyState" class="empty" style="display:none">No saved texts found.</div>
    </main>

    <!-- Footer (your provided footer markup) -->
    <footer class="mt-4 py-4 text-center">
      <div class="card-glass d-inline-block p-3 rounded-3">
        <div class="small muted mb-1">Made with Kavizz - CP Share TXT</div>
        <div class="small muted">© <span id="footerYear"></span> • Team Alpha Software Solutions - Kavizz</div>
      </div>
    </footer>
  </div>

  <!-- modal overlay element -->
  <div id="modalOverlay" aria-hidden="true"></div>

  <!-- View modal -->
  <div class="modal fade" id="viewModal" tabindex="-1" aria-labelledby="viewModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content" style="background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border:none;">
        <div class="modal-header border-0">
          <h5 class="modal-title" id="viewModalLabel">View full text</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="viewModalBody" style="white-space:pre-wrap;color:#dff9ff;max-height:60vh;overflow:auto;padding:1rem 1.25rem;"></div>
        <div class="modal-footer border-0">
          <button id="modalCopyBtn" class="small-btn" type="button"><i class="bi bi-clipboard"></i> Copy</button>
          <button class="small-btn" type="button" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Scroll-to-top bottom-right pill -->
  <div id="scrollSide" role="button" aria-label="Scroll to top" title="Scroll to top" tabindex="0">
    <div class="label" aria-hidden="true">TOP</div>
    <button id="scrollBtn" aria-hidden="true"><i class="bi bi-arrow-up-short"></i></button>
  </div>

  <!-- libs -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://unpkg.com/aos@2.3.4/dist/aos.js"></script>

  <script>
    AOS.init({ duration:380, once:true });

    // ENDPOINTS
    const API_JSON = 'load_data_json.php';
    const API_HTML = 'load_data.php';
    const API_DELETE = 'delete_data.php';
    const API_PROTECT = 'update_protection.php';

    // ELEMENTS
    const displayTextsBtn = document.getElementById('displayTextsBtn');
    const displayFilesBtn = document.getElementById('displayFilesBtn');
    const refreshBtn = document.getElementById('refreshBtn');
    const searchInput = document.getElementById('searchInput');
    const recordsList = document.getElementById('recordsList');
    const loadingRow = document.getElementById('loadingRow');
    const loadingText = document.getElementById('loadingText');
    const emptyState = document.getElementById('emptyState');
    const modalEl = document.getElementById('viewModal');
    const viewModal = new bootstrap.Modal(modalEl);
    const viewModalBody = document.getElementById('viewModalBody');
    const modalCopyBtn = document.getElementById('modalCopyBtn');
    const modalOverlay = document.getElementById('modalOverlay');
    const scrollSide = document.getElementById('scrollSide');
    const scrollBtn = document.getElementById('scrollBtn');
    const footerYear = document.getElementById('footerYear');

    // STATE
    let records = [];
    let loaded = false;
    let lastFilter = '';

    footerYear.textContent = new Date().getFullYear();

    // UTILS
    function esc(s){ return s==null ? '' : String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }
    function humanDate(sql){
      if(!sql) return '';
      try { const d = new Date(sql.replace(' ', 'T') + 'Z'); if (isNaN(d)) return sql; return d.toLocaleString(); } catch { return sql; }
    }

    // overlay
    function setOverlay(open){
      const isLight = document.body.classList.contains('light');
      if (open) {
        modalOverlay.style.display = 'block';
        modalOverlay.style.pointerEvents = 'auto';
        modalOverlay.style.opacity = '0';
        modalOverlay.style.zIndex = 1040;
        modalOverlay.style.backgroundColor = isLight ? 'rgba(255,255,255,0.75)' : 'rgba(0,0,0,0.65)';
        requestAnimationFrame(()=> modalOverlay.style.opacity = '1');
      } else {
        modalOverlay.style.opacity = '0';
        modalOverlay.style.pointerEvents = 'none';
        setTimeout(()=> modalOverlay.style.display = 'none', 220);
      }
    }

    // build record node
    function buildRecordNode(item, idx){
      const node = document.createElement('div');
      node.className = 'record';
      node.tabIndex = 0;
      node.dataset.idx = idx;
      node.innerHTML = `
        <div class="avatar" aria-hidden="true">${esc((item.username||'U').split(' ').map(p=>p[0]||'').slice(0,2).join('').toUpperCase())}</div>
        <div class="rec-body">
          <div class="rec-head">
            <div>
              <div class="rec-name" title="${esc(item.username)}">${esc(item.username)}</div>
              <div class="rec-time">${esc(humanDate(item.saved_at))}</div>
            </div>
            <div>${item.is_protected ? '<span class="protect-badge">Protected</span>' : ''}</div>
          </div>
          <div class="rec-text">${esc(item.preview || (item.fulltext||'').slice(0,800))}</div>
        </div>
        <div class="rec-actions" role="group" aria-label="Actions">
          <button class="small-btn copy-btn" data-idx="${idx}" title="Copy"><i class="bi bi-clipboard"></i></button>
          <button class="small-btn view-btn" data-idx="${idx}" title="View"><i class="bi bi-eye"></i></button>
          <button class="small-btn protect-btn ${item.is_protected ? 'protected' : ''}" data-idx="${idx}" title="Protect">${item.is_protected ? 'Protected' : 'Protect'}</button>
          <button class="small-btn btn-danger delete-btn" data-idx="${idx}" title="Delete"><i class="bi bi-trash"></i></button>
        </div>
      `;
      node.setAttribute('data-aos','fade-up');
      return node;
    }

    // render list
    function renderList(){
      recordsList.innerHTML = '';
      let list = records.slice();
      list.sort((a,b) => (new Date(b.saved_at).getTime()||0) - (new Date(a.saved_at).getTime()||0));
      const q = (lastFilter || '').trim().toLowerCase();
      if (q) list = list.filter(it => ((it.username||'') + ' ' + (it.fulltext||'')).toLowerCase().includes(q));
      if (!list.length) { emptyState.style.display = 'block'; return; } else emptyState.style.display = 'none';
      list.forEach(r => {
        const originalIndex = records.indexOf(r);
        const node = buildRecordNode(r, originalIndex);
        recordsList.appendChild(node);
      });
      AOS.refresh();
    }

    // try JSON then HTML fallback
    async function loadRecords(){
      loadingRow.style.display = 'flex';
      recordsList.setAttribute('aria-busy','true');
      try {
        const res = await fetch(API_JSON, { cache: 'no-store' });
        if (!res.ok) throw new Error('JSON not available');
        const data = await res.json();
        if (!Array.isArray(data)) throw new Error('JSON not array');
        records = data.map(it => ({
          username: it.username || it.name || 'Anonymous',
          fulltext: it.fulltext ?? it.text ?? it.content ?? '',
          preview: it.preview ?? ((it.fulltext ?? it.text ?? '').slice(0,800)),
          is_protected: Number(it.is_protected || it.protected || 0),
          saved_at: it.saved_at ?? it.created_at ?? ''
        }));
        loaded = true;
        loadingRow.style.display = 'none';
        renderList();
      } catch (jsonErr) {
        try {
          const res2 = await fetch(API_HTML, { cache: 'no-store' });
          if (!res2.ok) throw new Error('HTML not available');
          const html = await res2.text();
          const parsed = parseHtmlTable(html);
          records = parsed.map(it => ({
            username: it.username,
            fulltext: it.fulltext,
            preview: it.preview,
            is_protected: it.is_protected ? 1 : 0,
            saved_at: it.saved_at
          }));
          loaded = true;
          loadingRow.style.display = 'none';
          renderList();
        } catch (htmlErr) {
          console.error('Load failed', jsonErr, htmlErr);
          loadingRow.style.display = 'none';
          records = [];
          renderList();
          Swal.fire({ icon:'error', title:'Could not load records', text:'Server returned an error or no data.' });
        }
      } finally {
        recordsList.setAttribute('aria-busy','false');
      }
    }

    function parseHtmlTable(htmlString){
      try {
        const tmp = document.createElement('div');
        tmp.innerHTML = htmlString;
        const rows = tmp.querySelectorAll('tbody tr');
        if (!rows || rows.length === 0) return [];
        const items = [];
        rows.forEach(row => {
          const usernameSpan = row.querySelector('.username-link') || row.querySelector('[data-username]');
          let username = '', fulltext = '';
          if (usernameSpan) {
            username = usernameSpan.getAttribute('data-username') || usernameSpan.textContent.trim();
            fulltext = usernameSpan.getAttribute('data-fulltext') || usernameSpan.getAttribute('title') || usernameSpan.textContent.trim();
          } else {
            const first = row.querySelector('td');
            username = first ? first.textContent.trim() : 'Anonymous';
          }
          const protectInput = row.querySelector('input[type="checkbox"].protect-toggle');
          const isProtected = protectInput ? protectInput.checked : false;
          const savedAtCell = row.querySelector('td:nth-child(3)') || row.querySelector('.badge');
          const savedAt = savedAtCell ? savedAtCell.textContent.trim() : '';
          const previewCell = row.querySelector('td:nth-child(2)');
          const preview = previewCell ? previewCell.textContent.trim() : (fulltext || '').slice(0,800);
          items.push({ username, fulltext, preview, is_protected: isProtected ? 1 : 0, saved_at: savedAt });
        });
        return items;
      } catch (e) {
        console.error('parseHtmlTable error', e);
        return [];
      }
    }

    // Copy helper with fallback
    async function copyToClipboard(text) {
      if (!text) return false;
      if (navigator.clipboard && navigator.clipboard.writeText) {
        try {
          await navigator.clipboard.writeText(text);
          return true;
        } catch (e) {}
      }
      try {
        const ta = document.createElement('textarea');
        ta.value = text;
        ta.setAttribute('readonly','');
        ta.style.position = 'absolute';
        ta.style.left = '-9999px';
        document.body.appendChild(ta);
        ta.select();
        ta.setSelectionRange(0, ta.value.length);
        const ok = document.execCommand('copy');
        ta.remove();
        return !!ok;
      } catch (err) {
        return false;
      }
    }

    // Action delegation
    document.addEventListener('click', async (ev) => {
      // Copy
      const copyBtn = ev.target.closest('.copy-btn');
      if (copyBtn) {
        if (!loaded) { Swal.fire({ icon:'info', title:'Load first', text:'Click Display Texts to load records.' }); return; }
        const idx = Number(copyBtn.dataset.idx);
        const it = records[idx];
        const ok = await copyToClipboard(it.fulltext);
        if (ok) Swal.fire({ toast:true, position:'top-end', icon:'success', title:'Copied to clipboard', showConfirmButton:false, timer:1200, timerProgressBar:true });
        else Swal.fire({ icon:'error', title:'Copy failed', text:'Your browser refused the copy action.' });
        return;
      }

      // View
      const viewBtn = ev.target.closest('.view-btn');
      if (viewBtn) {
        if (!loaded) { Swal.fire({ icon:'info', title:'Load first', text:'Click Display Texts to load records.' }); return; }
        const idx = Number(viewBtn.dataset.idx);
        const it = records[idx];
        viewModalBody.textContent = it.fulltext;
        setOverlay(true);
        viewModal.show();
        return;
      }

      // Protect
      const protectBtn = ev.target.closest('.protect-btn');
      if (protectBtn) {
        if (!loaded) { Swal.fire({ icon:'info', title:'Load first', text:'Click Display Texts to load records.' }); return; }
        const idx = Number(protectBtn.dataset.idx);
        const it = records[idx];
        const newStatus = it.is_protected ? 0 : 1;
        it.is_protected = newStatus;
        renderList(); // optimistic
        try {
          const form = new URLSearchParams();
          form.append('username', it.username);
          form.append('is_protected', newStatus);
          const resp = await fetch(API_PROTECT, { method:'POST', body: form });
          const j = await resp.json();
          if (!j || j.status !== 'success') {
            it.is_protected = newStatus ? 0 : 1;
            renderList();
            Swal.fire({ icon:'error', title:'Update failed', text:(j && j.message) ? j.message : 'Server error' });
          } else {
            Swal.fire({ toast:true, position:'top-end', icon:'success', title: newStatus ? 'Protected' : 'Unprotected', showConfirmButton:false, timer:1100, timerProgressBar:true });
          }
        } catch (err) {
          it.is_protected = newStatus ? 0 : 1;
          renderList();
          Swal.fire({ icon:'error', title:'Network error', text:'Could not update protection' });
        }
        return;
      }

      // Delete
      const delBtn = ev.target.closest('.delete-btn');
      if (delBtn && delBtn.closest('.record')) {
        if (!loaded) { Swal.fire({ icon:'info', title:'Load first', text:'Click Display Texts to load records.' }); return; }
        const idx = Number(delBtn.dataset.idx);
        const it = records[idx];
        const conf = await Swal.fire({
          title: `Delete "${it.username}"?`,
          text: "This action cannot be undone.",
          icon: 'warning',
          showCancelButton: true,
          confirmButtonText: 'Delete',
          confirmButtonColor: '#d33'
        });
        if (conf.isConfirmed) {
          try {
            const form = new URLSearchParams();
            form.append('delete_username', it.username);
            const res = await fetch(API_DELETE, { method:'POST', body: form });
            const j = await res.json();
            if (j && j.status === 'success') {
              records = records.filter(r => !(r.username === it.username && r.saved_at === it.saved_at));
              renderList();
              Swal.fire({ toast:true, position:'top-end', icon:'success', title:'Deleted', showConfirmButton:false, timer:1100, timerProgressBar:true });
            } else {
              Swal.fire({ icon:'error', title:'Delete failed', text:(j && j.message) ? j.message : 'Server error' });
            }
          } catch (err) {
            Swal.fire({ icon:'error', title:'Network error', text:'Could not delete entry' });
          }
        }
        return;
      }
    });

    // modal copy
    modalCopyBtn.addEventListener('click', async () => {
      const txt = viewModalBody.textContent || '';
      const ok = await copyToClipboard(txt);
      if (ok) Swal.fire({ toast:true, position:'top-end', icon:'success', title:'Copied', showConfirmButton:false, timer:1000, timerProgressBar:true });
      else Swal.fire({ icon:'error', title:'Copy failed' });
    });

    // modal overlay handling
    modalEl.addEventListener('shown.bs.modal', () => setOverlay(true));
    modalEl.addEventListener('hidden.bs.modal', () => setOverlay(false));

    // search live
    searchInput.addEventListener('input', (e) => {
      lastFilter = e.target.value || '';
      if (loaded) renderList();
    });

    // display texts button
    displayTextsBtn.addEventListener('click', () => {
      if (!loaded) loadRecords();
      else Swal.fire({ icon:'info', title:'Records already loaded', text:'Use Refresh to reload from server.' });
    });

    // refresh button
    refreshBtn.addEventListener('click', () => {
      if (!loaded) Swal.fire({ icon:'info', title:'Load first', text:'Click Display Texts to load records.' });
      else loadRecords();
    });

    // display files button navigates to backend.php
    displayFilesBtn.addEventListener('click', () => {
      window.location.href = 'backend.php';
    });

    // theme handling
    function applyTheme() {
      const stored = localStorage.getItem('cp_theme');
      if (stored) {
        if (stored === 'light') document.body.classList.add('light'); else document.body.classList.remove('light');
      } else {
        const prefersLight = window.matchMedia && window.matchMedia('(prefers-color-scheme: light)').matches;
        if (prefersLight) document.body.classList.add('light');
      }
      if (document.body.classList.contains('light')) document.getElementById('themeIcon').className = 'bi bi-moon-fill';
      else document.getElementById('themeIcon').className = 'bi bi-sun-fill';
      if (document.querySelector('.modal.show')) setOverlay(true);
    }
    applyTheme();
    document.getElementById('themeToggle').addEventListener('click', () => {
      document.body.classList.toggle('light');
      const isLight = document.body.classList.contains('light');
      localStorage.setItem('cp_theme', isLight ? 'light' : 'dark');
      document.getElementById('themeIcon').className = isLight ? 'bi bi-moon-fill' : 'bi bi-sun-fill';
    });

    // scroll button behavior
    window.addEventListener('scroll', () => {
      if (window.scrollY > 160) scrollSide.classList.add('show'); else scrollSide.classList.remove('show');
    });
    scrollSide.addEventListener('click', () => window.scrollTo({ top:0, behavior:'smooth' }));
    scrollSide.addEventListener('keydown', (e) => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); window.scrollTo({ top:0, behavior:'smooth' }); } });

    // keyboard nav: Enter opens record
    recordsList.addEventListener('keydown', (e) => {
      const rec = e.target.closest('.record');
      if (!rec) return;
      if (e.key === 'Enter') {
        const idx = Number(rec.dataset.idx);
        if (records[idx]) {
          viewModalBody.textContent = records[idx].fulltext;
          viewModal.show();
        }
      }
    });

    // initial states
    searchInput.value = '';
  </script>
</body>
</html>
